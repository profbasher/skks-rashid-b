<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Savings Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-black p-4">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">Savings Manager</h1>

    <!-- Form -->
    <form id="savingsForm" class="grid grid-cols-2 gap-4 bg-gray-100 p-4 rounded-lg mb-6">
      <select id="month" name="month" class="p-2 border rounded" required>
        <option disabled>Select Month</option>
        <script>
          const months = ["January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December"];
          const monthNow = new Date().toLocaleString('en-US', { timeZone: 'Asia/Dhaka', month: 'long' });
          document.write(months.map(m => `<option ${m === monthNow ? "selected" : ""}>${m}</option>`).join(''));
        </script>
      </select>
      <input type="number" id="savings" name="savings" placeholder="Savings" class="p-2 border rounded" required />
      <input type="number" id="profit" name="profit" placeholder="Profit" class="p-2 border rounded" required />
      <input type="number" id="withdraw" name="withdraw" placeholder="Withdraw" class="p-2 border rounded" required />
      <input type="number" id="total" name="total" placeholder="Total" class="p-2 border rounded bg-gray-200" disabled />
      <input type="number" id="loan" name="loan" placeholder="Loan" class="p-2 border rounded" required />
      <input type="number" id="instalment" name="instalment" placeholder="Instalment" class="p-2 border rounded" required />
      <input type="number" id="instalment_no" name="instalment_no" placeholder="Instalment No" class="p-2 border rounded" required />
      <input type="number" id="instalment_due" name="instalment_due" placeholder="Instalment Due" class="p-2 border rounded bg-gray-200" disabled />
      <input type="date" id="receive_date" name="receive_date" class="p-2 border rounded" required />
      <input type="text" id="receiver" name="receiver" placeholder="Receiver" class="p-2 border rounded" required />
      <input type="text" id="message" name="message" placeholder="Message" class="p-2 border rounded" />
      <button type="submit" class="col-span-2 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Save Entry</button>
    </form>

    <!-- Search -->
    <div class="mb-4 flex items-center gap-2">
      <input type="text" id="search" placeholder="Search..." class="p-2 border rounded w-full" />
      <button id="clearSearch" class="text-red-500 text-xl font-bold hidden">&times;</button>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
      <table class="w-full table-auto border">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 border">Month</th>
            <th class="p-2 border">Savings</th>
            <th class="p-2 border">Profit</th>
            <th class="p-2 border">Withdraw</th>
            <th class="p-2 border">Total</th>
            <th class="p-2 border">Loan</th>
            <th class="p-2 border">Instalment</th>
            <th class="p-2 border">Instalment No</th>
            <th class="p-2 border">Instalment Due</th>
            <th class="p-2 border">Receive Date</th>
            <th class="p-2 border">Receiver</th>
            <th class="p-2 border">Message</th>
            <th class="p-2 border">Action</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxxCfN-IZSjWpUgDdNxKMs7ckaI2j_W4ucuq74hplH-DbUKhrXxwvIhZKvukarHQpKqxw/exec"; // Replace with your Apps Script URL
    const form = document.getElementById('savingsForm');
    const searchInput = document.getElementById('search');
    const clearSearch = document.getElementById('clearSearch');
    const tableBody = document.getElementById('tableBody');

    const nowBD = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Dhaka" }));
    document.getElementById("receive_date").value = nowBD.toISOString().slice(0, 10);

    function calcTotalAndDue(savings, profit, withdraw, lastTotal, inst, instNo, lastDue) {
      const total = (+savings + +profit + +lastTotal) - +withdraw;
      const instalmentDue = (+inst * +instNo) - +lastDue;
      return { total, instalmentDue };
    }

    async function fetchData() {
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: "read" }),
      });
      return res.json();
    }

    async function renderTable() {
      const data = await fetchData();
      tableBody.innerHTML = "";
      data.reverse().forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border p-1">${row.month}</td>
          <td class="border p-1">${row.savings}</td>
          <td class="border p-1">${row.profit}</td>
          <td class="border p-1">${row.withdraw}</td>
          <td class="border p-1">${row.total}</td>
          <td class="border p-1">${row.loan}</td>
          <td class="border p-1">${row.instalment}</td>
          <td class="border p-1">${row.instalment_no}</td>
          <td class="border p-1">${row.instalment_due}</td>
          <td class="border p-1">${row.receive_date}</td>
          <td class="border p-1">${row.receiver}</td>
          <td class="border p-1">${row.message}</td>
          <td class="border p-1 text-center"><button onclick="deleteRow('${row.id}')" class="text-red-500">Delete</button></td>
        `;
        tableBody.appendChild(tr);
      });
    }

    async function deleteRow(id) {
      await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: "delete", id }),
      });
      renderTable();
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = new FormData(form);
      const values = Object.fromEntries(f.entries());
      const data = await fetchData();
      const last = data[data.length - 1] || {};
      const { total, instalmentDue } = calcTotalAndDue(values.savings, values.profit, values.withdraw, last.total || 0, values.instalment, values.instalment_no, last.instalment_due || 0);
      values.total = total;
      values.instalment_due = instalmentDue;
      values.action = "create";
      await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(values),
      });
      form.reset();
      renderTable();
    });

    searchInput.addEventListener('input', async () => {
      clearSearch.classList.toggle("hidden", !searchInput.value);
      const data = await fetchData();
      const query = searchInput.value.toLowerCase();
      tableBody.innerHTML = "";
      data.filter(row => Object.values(row).some(v => String(v).toLowerCase().includes(query)))
          .forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="border p-1">${row.month}</td>
              <td class="border p-1">${row.savings}</td>
              <td class="border p-1">${row.profit}</td>
              <td class="border p-1">${row.withdraw}</td>
              <td class="border p-1">${row.total}</td>
              <td class="border p-1">${row.loan}</td>
              <td class="border p-1">${row.instalment}</td>
              <td class="border p-1">${row.instalment_no}</td>
              <td class="border p-1">${row.instalment_due}</td>
              <td class="border p-1">${row.receive_date}</td>
              <td class="border p-1">${row.receiver}</td>
              <td class="border p-1">${row.message}</td>
              <td class="border p-1 text-center"><button onclick="deleteRow('${row.id}')" class="text-red-500">Delete</button></td>
            `;
            tableBody.appendChild(tr);
          });
    });

    clearSearch.addEventListener('click', () => {
      searchInput.value = "";
      clearSearch.classList.add("hidden");
      renderTable();
    });

    renderTable();
  </script>
</body>
</html>
